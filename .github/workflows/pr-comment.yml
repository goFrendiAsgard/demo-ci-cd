name: Comment on PR and Code Review

on:
  pull_request:
    branches:
      - main

jobs:
  code-review:
    runs-on: ubuntu-latest
    container:
      image: stalchmst/zrb:1.16.2
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Fetch all history for all branches and tags

      - name: Mark repository as safe
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Fetch PR branches
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}:${{ github.event.pull_request.base.ref }}
          git fetch origin ${{ github.event.pull_request.head.ref }}:${{ github.event.pull_request.head.ref }}

      - name: Debugging - Check git status
        run: |
          pwd
          ls -la
          git status
          git remote -v
          git branch -a

      - name: Run zrb code-review and post comment
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
        run: |
          set -e
          echo "Running code review for PR from $GITHUB_HEAD_REF to $GITHUB_BASE_REF..."
          REVIEW_COMMENT=$(zrb code-review --source "$GITHUB_HEAD_REF" --target "$GITHUB_BASE_REF")
          zrb submit-comment --comment "$REVIEW_COMMENT"
